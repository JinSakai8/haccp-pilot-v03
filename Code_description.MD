# Code Roadmap: HACCP Pilot v03-00

Witamy w projekcie **HACCP Pilot**. Ten dokument pomoÅ¼e Ci zrozumieÄ‡ obecnÄ… strukturÄ™ kodu, kluczowe decyzje architektoniczne i sposÃ³b, w jaki budujemy nowe funkcje.

## 1. Filozofia Projektu

- **Glove-Friendly UX:** Wszystkie elementy interaktywne muszÄ… mieÄ‡ min. **60x60dp**. Unikamy klawiatury systemowej (korzystamy z `HaccpNumPad` lub gotowych opcji).
- **Dark Mode Only:** Aplikacja dziaÅ‚a tylko w trybie ciemnym (kuchennym).
- **Offline-First / Online-Integration:** Dane sÄ… zbierane lokalnie, a synchronizacja (np. zdjÄ™cia) nastÄ™puje przy finalizacji.

## 2. Struktura FolderÃ³w (`lib/`)

Projekt podzielony jest na **Features** (funkcjonalnoÅ›ci) i **Core** (wspÃ³lne utilities).

```
lib/
â”œâ”€â”€ core/                  # Fundamenty aplikacji
â”‚   â”œâ”€â”€ config/            # Env, staÅ‚e konfiguracyjne
â”‚   â”œâ”€â”€ constants/         # Design Tokens (kolory, wymiary)
â”‚   â”œâ”€â”€ router/            # GoRouter (nawigacja)
â”‚   â”œâ”€â”€ theme/             # Motyw Fluttera (Dark Theme)
â”‚   â””â”€â”€ widgets/           # Globalne widgety (TopBar, Tile)
â”‚
â”œâ”€â”€ features/              # ModuÅ‚y biznesowe (M01, M02, ...)
â”‚   â”œâ”€â”€ m01_auth/          # Logowanie (PIN Pad)
â”‚   â”œâ”€â”€ m02_monitoring/    # IoT (Dashboard temperatur)
â”‚   â”œâ”€â”€ m03_gmp/           # Procesy produkcyjne (Pieczenie itp.)
â”‚   â”‚   â””â”€â”€ screens/       # Ekrany specyficzne dla moduÅ‚u
â”‚   â”‚
â”‚   â””â”€â”€ shared/            # !!! KLUCZOWY MODUÅ WSPÃ“LNY !!!
â”‚       â”œâ”€â”€ models/        # Modele silnika formularzy (FormDefinition)
â”‚       â”œâ”€â”€ providers/     # Logika Riverpod (DynamicFormNotifier)
â”‚       â””â”€â”€ widgets/       # Komponenty formularzy (Stepper, Toggle)
```

## 3. Silnik Formularzy Dynamicznych (The Engine)

WiÄ™kszoÅ›Ä‡ ekranÃ³w w M03 (GMP) i M04 (GHP) to formularze. Zamiast pisaÄ‡ kaÅ¼dy ekran rÄ™cznie, stworzyliÅ›my **silnik**, ktÃ³ry buduje UI na podstawie konfiguracji (JSON-like).

### Kluczowe Pliki

1. **`lib/features/shared/widgets/dynamic_form/dynamic_form_renderer.dart`**
    - To jest "Serce". Bierze listÄ™ `FormFieldConfig` i zamienia jÄ… na widgety (`ListView`).
    - ObsÅ‚uguje **Non-Blocking Policy**: JeÅ›li parametr jest poza normÄ… (np. temp < 75Â°C), pojawia siÄ™ ostrzeÅ¼enie i *wymuszone pole komentarza*. Nie blokujemy zapisu!

2. **`lib/features/shared/providers/dynamic_form_provider.dart`**
    - ZarzÄ…dza stanem (wartoÅ›ciami pÃ³l, bÅ‚Ä™dami walidacji, widocznoÅ›ciÄ…).
    - UÅ¼ywa **Riverpod** (`autoDispose`), wiÄ™c stan czyÅ›ci siÄ™ po wyjÅ›ciu z ekranu.

3. **Modele (`lib/features/shared/models/form_definition.dart`)**
    - `FormDefinition`: Lista pÃ³l.
    - `FormFieldConfig`: Konfiguracja pojedynczego pola (typ, label, min/max, wymagane).

### Glove-Friendly Widgets

Te komponenty znajdujÄ… siÄ™ w `lib/features/shared/widgets/dynamic_form/`:

- **`HaccpStepper`**: Wielkie przyciski `+` / `-` do wprowadzania liczb (np. temperatura).
- **`HaccpToggle`**: Kafelki `OK` (zielony) / `PROBLEM` (czerwony) zamiast maÅ‚ych switchy.
- **`HaccpNumPadInput`**: Pole tekstowe (read-only), ktÃ³re po klikniÄ™ciu otwiera duÅ¼Ä… klawiaturÄ™ numerycznÄ… w BottomSheet.

## 4. Jak dodaÄ‡ nowy ekran procesu (np. ChÅ‚odzenie)?

Nie musisz budowaÄ‡ caÅ‚ego UI od zera.

1. StwÃ³rz nowy plik w `lib/features/m03_gmp/screens/` (np. `cooling_form_screen.dart`).
2. Zdefiniuj strukturÄ™ formularza w zmiennej `FormDefinition`:

    ```dart
    final coolingFormDef = FormDefinition(
      fields: [
        FormFieldConfig(
          id: 'temp_start',
          type: HaccpFieldType.stepper,
          label: 'Temp. PoczÄ…tkowa',
          config: {'min': 0, 'max': 100},
        ),
        // ... wiÄ™cej pÃ³l
      ],
    );
    ```

3. UÅ¼yj `DynamicFormRenderer` w metodzie `build`:

    ```dart
    return Scaffold(
      body: DynamicFormRenderer(
        formId: 'cooling_process',
        definition: coolingFormDef,
      ),
    );
    ```

4. Podepnij stan pod przycisk "Zapisz", aby sprawdziÄ‡ `isValid`.

## 5. State Management (Riverpod)

UÅ¼ywamy generatorÃ³w kodu (`riverpod_annotation`).

- JeÅ›li zmienisz cokolwiek w plikach z adnotacjÄ… `@riverpod`, musisz uruchomiÄ‡:
    `dart run build_runner build --delete-conflicting-outputs`
- Provider logiczny formularza to `dynamicFormProvider`.

## 6. ModuÅ‚ M02 (Monitoring IoT)

Ten moduÅ‚ jest nieco inny â€“ sÅ‚uÅ¼y do podglÄ…du danych "na Å¼ywo".

- Ekrany: `TemperatureDashboardScreen`.
- UI: Karty sensorÃ³w zmieniajÄ… kolor zaleÅ¼nie od odchyÅ‚ki od normy (Zielony/PomaraÅ„czowy/Czerwony).

## 7. ModuÅ‚ M05 (Odpady & Aparat)

Ten moduÅ‚ wprowadza natywnÄ… obsÅ‚ugÄ™ kamery bez interfejsu systemowego (Glove-Friendly).

### Kluczowe Komponenty

1. **`lib/features/m05_waste/screens/haccp_camera_screen.dart`**
    - Specjalny ekran aparatu uÅ¼ywajÄ…cy paczki `camera`.
    - Brak maÅ‚ych przyciskÃ³w systemowych.
    - **Gigantyczny spust migawki (100dp).**
    - Tryb "Review": Wielkie przyciski "PONÃ“W" (Orange) i "ZATWIERDÅ¹" (Green).

2. **`lib/core/services/storage_service.dart`**
    - ObsÅ‚uguje kompresjÄ™ zdjÄ™Ä‡ (max 1024px, quality 80%).
    - WysyÅ‚a pliki do Supabase Storage (`waste-docs`).
    - Zwraca Å›cieÅ¼kÄ™ do pliku, ktÃ³rÄ… zapisujemy w bazie.

3. **`HaccpLongPressButton`**
    - Widget bezpieczeÅ„stwa. Wymaga przytrzymania przycisku przez 1 sekundÄ™, aby zatwierdziÄ‡ akcjÄ™ (np. wysÅ‚anie zdjÄ™cia, zapis formularza). Zapobiega przypadkowym klikniÄ™ciom w poÅ›piechu.

### PrzepÅ‚yw Danych M05

1. **Panel OdpadÃ³w** (`WastePanelScreen`): Pobiera ostatnie wpisy z `waste_records`.
2. **Rejestracja**: UÅ¼ytkownik wybiera typ (Kafelki), wagÄ™ (Stepper) i firmÄ™.
3. **ZdjÄ™cie**:
    - Otwiera `HaccpCameraScreen`.
    - Robi zdjÄ™cie ->ZatwierdÅº -> Kompresja -> Upload -> Return Path.
4. **Zapis**: Formularz wysyÅ‚a komplet danych (z path zdjÄ™cia) do `WasteRepository`.

---

## 8. ModuÅ‚ M06 (Raportowanie & Drive)

ModuÅ‚ odpowiedzialny za generowanie dokumentacji i archiwizacjÄ™ w chmurze.

### 14.1 ModuÅ‚ M06: Raporty Temperatur (Detale Techniczne)

Raporty temperatur sÄ… najbardziej zÅ‚oÅ¼onym elementem moduÅ‚u M06 ze wzglÄ™du na wolumen danych (tysiÄ…ce pomiarÃ³w na sensor miesiÄ™cznie).

#### Proces Generowania

1. **Pobieranie Danych (`ReportsRepository.getMeasurements`)**:
    - Zapytanie do tabeli `temperature_logs`.
    - **Data Join**: Wykonujemy `JOIN` z tabelÄ… `sensors`, aby uzyskaÄ‡ czytelne nazwy urzÄ…dzeÅ„ (np. "ChÅ‚odnia MiÄ™so") zamiast surowych identyfikatorÃ³w UUID.
    - Filtrowanie: Po zakresie dat (caÅ‚y miesiÄ…c) oraz opcjonalnie po konkretnym `sensor_id`.
2. **Agregacja (`TemperatureAggregatorService`)**:
    - PoniewaÅ¼ wyÅ›wietlanie kaÅ¼dego pomiaru (co 5 min) zajÄ™Å‚oby setki stron, dane sÄ… agregowane do **statystyk dziennych**.
    - Dla kaÅ¼dego dnia i kaÅ¼dego urzÄ…dzenia wyliczane sÄ…: `min`, `max`, `avg` oraz `measurement_count`.
    - System sprawdza rÃ³wnieÅ¼ wystÄ…pienie alarmÃ³w krytycznych (breaches).
3. **Generowanie Wizualne (`HtmlReportGenerator`)**:
    - Agregaty sÄ… przekazywane do generatora HTML.
    - Tworzony jest profesjonalny dokument HTML z sekcjÄ… podsumowania (Summary Cards) i tabelÄ… szczegÃ³Å‚owÄ….
    - Stylizacja oparta jest na CSS zgodnym z designem aplikacji (akcenty `#D2661E`).
4. **PodglÄ…d i Druk**:
    - Wygenerowany kod HTML jest konwertowany na PDF (lub renderowany bezpoÅ›rednio w widoku Web) i otwierany za pomocÄ… `FileOpener`.

#### Å¹rÃ³dÅ‚a Danych (Database Mapping)

- **Tabela:** `temperature_logs` (pomiary).
- **Relacja:** `sensors_id` -> `sensors.id` (nazwa urzÄ…dzenia).
- **Branding:** Nazwa lokalu i logo pobierane sÄ… z tabeli `venues` via `VenueRepository`.

---

### Generowanie RaportÃ³w (M06)

- **Raporty PDF (`PdfService`)**: UÅ¼ywa `syncfusion_flutter_pdf` do generowania raportÃ³w GMP/GHP i OdpadÃ³w.
- **Raporty Temperatur (HTML)**: Ze wzglÄ™du na duÅ¼Ä… iloÅ›Ä‡ danych (tysiÄ…ce pomiarÃ³w miesiÄ™cznie), raporty temperatur sÄ… najpierw agregowane do statystyk dziennych (`TemperatureAggregatorService`), a nastÄ™pnie renderowane do formatu HTML (`HtmlReportGenerator`).
- **Agregacja**: Wylicza Min, Max i ÅšredniÄ… temperaturÄ™ dla kaÅ¼dego urzÄ…dzenia w kaÅ¼dym dniu miesiÄ…ca.
- **WyrÃ³Å¼nienie AlarmÃ³w**: HTML automatycznie koloruje na czerwono wartoÅ›ci przekraczajÄ…ce progi (np. > 8Â°C dla lodÃ³wek).
- **Otwieranie plikÃ³w**: Wykorzystuje `FileOpener` do podglÄ…du HTML/PDF w nowej karcie przeglÄ…darki (Web).

### 2.3 Web Compatibility & Platform Specifics

- **NO `dart:io`**: Aplikacja jest w peÅ‚ni kompatybilna z Web. Wszystkie uÅ¼ycia `dart:io` zostaÅ‚y usuniÄ™te lub zabezpieczone przez `kIsWeb`.
- **File Opener (`lib/core/services/file_opener.dart`)**: Specjalny helper wykorzystujÄ…cy **warunkowe importy** (`dart:html` na web, stub na mobile). Pozwala na otwieranie wygenerowanych raportÃ³w bezpoÅ›rednio w nowej karcie przeglÄ…darki.
- **Blob Handling**: Pliki sÄ… obsÅ‚ugiwane jako `Uint8List` w pamiÄ™ci, co eliminuje potrzebÄ™ zapisu na dysku lokalnym przed wysyÅ‚kÄ… do Supabase/Drive.
- **Printing**: Raporty HTML sÄ… zoptymalizowane pod kÄ…tem wydruku systemowego (`@media print`).

## 3. Key Modules & Providers

### Core

- `auth_provider.dart`: Global auth state (Supabase User + Employee Profile).
- `app_router.dart`: GoRouter configuration with AuthGuard.
- `pdf_service.dart`: Universal PDF generation (Web/Mobile).
- `drive_service.dart`: Google Drive API integration (Web-compatible via HTTP).
- `storage_service.dart`: Supabase Storage wrapper.

### Feature Modules

- **M01 Login**: PIN/Password handlers.
- **M05 Waste**: Waste registration, Photo upload (Direct binary upload), History.
- **M06 Reports**: PDF generation (`ReportData` state), Google Drive export. `reportsProvider` handles state.
- **M08 Settings**: Venue settings, Logo upload (Uint8List).

## 4. Deployment & Build

- **Vercel**: Automated CI/CD.
- **Build Script**: `vercel_build.sh` handles Flutter setup and build.
- **Command**: `bash vercel_build.sh`
- **Output**: `build/web`

### Google Drive (`DriveService`)

- **Auth**: Service Account (plik `assets/credentials.json`). Nie wymaga logowania uÅ¼ytkownika "na tablecie".
- **Folder**: ID folderu docelowego jest w `.env`.
- **Funkcje**: Upload plikÃ³w (`uploadReport`) oraz listowanie zawartoÅ›ci folderu (`listFiles`).

---

## 9. ModuÅ‚ M07 (HR & Personel)

ModuÅ‚ do zarzÄ…dzania pracownikami, ich rolami (Manager/Pracownik) oraz waÅ¼noÅ›ciÄ… badaÅ„ Sanepid.

### Struktura (`lib/features/m07_hr/`)

- **Repositories**: `HrRepository` - obsÅ‚uguje tabelÄ™ `employees` poprzez **Secure RPCs**, co pozwala na bezpieczne modyfikacje przez uÅ¼ytkownikÃ³w anonimowych (Kiosk mode).
- **Providers**: `HrProvider` - zarzÄ…dza listÄ… pracownikÃ³w i logikÄ… dodawania/edycji.
- **Ekrany**:
  - `EmployeeListScreen`: Lista z filtrowaniem i feedbackiem "Pracownik dodany".
  - `AddEmployeeScreen`: Dodawanie pracownika z blokadÄ… przycisku dla duplikatÃ³w PIN oraz **przypisywaniem stref (Zones)**.
  - `EmployeeProfileScreen`: Profil z obsÅ‚ugÄ… bÅ‚Ä™dÃ³w przeÅ‚Ä…cznika statusu i **aktualizacjÄ… daty Sanepid** z potwierdzeniem.

### Kluczowe funkcje

- **Role Guards**: Tylko `manager` i `owner` majÄ… dostÄ™p do tras `/hr/*`. Zaimplementowane w `AppRouter`.
- **Sanepid Status**: Wizualizacja statusu badaÅ„ (Zielony > 30 dni, Å»Ã³Å‚ty < 30 dni, Czerwony = po terminie).

---

## 10. ModuÅ‚ M08 (Ustawienia & Polish)

ModuÅ‚ zamykajÄ…cy, obsÅ‚ugujÄ…cy dane lokalu i Å‚Ä…cznoÅ›Ä‡.

### Ustawienia Lokalu (`VenueRepository`)

- Pozwala na zmianÄ™ nazwy lokalu, NIPu i adresu.
- **Logo Upload**: UÅ¼ytkownik moÅ¼e wgraÄ‡ logo using `file_picker` (dziaÅ‚a na Web), ktÃ³re jest zapisywane w bucket `branding`.
- **Sensory Config**: Ustawianie interwaÅ‚u pomiarÃ³w (5/15/60 min) i progu alarmowego dla sensorÃ³w.
- **PDF Integration**: Logo jest automatycznie pobierane i wstawiane do nagÅ‚Ã³wka kaÅ¼dego generowanego raportu PDF.

### Connectivity & Offline Mode

- **`ConnectivityService`**: NasÅ‚uchuje zmian stanu sieci.
- **UI**: W `HaccpTopBar` pojawia siÄ™ czerwona ikona "Cloud Off", gdy tablet straci poÅ‚Ä…czenie. Aplikacja nie blokuje pracy (Offline-First), ale ostrzega uÅ¼ytkownika.

### UX Audit (Glove-Friendly Polish)

- Przycisk "Zapisz" w ustawieniach i formularzach uÅ¼ywa `HaccpLongPressButton` (wymaga przytrzymania).
- Wszystkie kluczowe interakcje sÄ… przystosowane do obsÅ‚ugi w rÄ™kawiczkach (przyciski min. 60x60dp).
- **Navigation Safety**: WdroÅ¼ono `GoRouter` we wszystkich moduÅ‚ach, eliminujÄ…c niespÃ³jnoÅ›ci `Navigatora`.
- **Empty States**: Wprowadzono `HaccpEmptyState` - spÃ³jny widget informujÄ…cy o braku danych (np. historycznych), zastÄ™pujÄ…cy surowe listy.
- **Data Seeding**: Dodano skrypt `18_seed_monitoring.sql` do generowania syntetycznych danych IoT (sensory, pomiary, alerty) dla celÃ³w testowych i prezentacyjnych.
- **Monitoring Polish**: Ujednolicono wyÅ›wietlanie nazw sensorÃ³w w panelu alarmÃ³w oraz dodano mechanizmy obronne przed niepoprawnym stanem sesji strefy.

---

## 11. Security Hardening (Directive 10a)

WdroÅ¼ono zaawansowane mechanizmy bezpieczeÅ„stwa zgodnie z audytem 10a.

### Brute-Force Protection

- **Logika**: 5 bÅ‚Ä™dnych prÃ³b = 30s blokady. 10 prÃ³b = 5min. 20 prÃ³b = 30min.
- **UI**: Ekran `PinPadScreen` blokuje klawiaturÄ™ i wyÅ›wietla odliczanie.
- **State**: Stan blokady jest trzymany w pamiÄ™ci (`PinLoginNotifier`), resetowany po upÅ‚ywie czasu.

### Data Access Layer

- **RLS (Row Level Security)**: WÅ‚Ä…czono w Supabase dla tabeli `employees`.
- **Public View**: `HrRepository` korzysta z bezpiecznego widoku `public_employees`, ktÃ³ry fizycznie wyklucza kolumnÄ™ `pin_hash` z wynikÃ³w zapytania.
- **Audit Columns**: Tabele posiadajÄ… `created_by` i `updated_by` uzupeÅ‚niane automatycznie przez trigger `handle_updated_at` i `handle_audit`.

### Credential Safety

- **.gitignore**: Plik `assets/credentials.json` oraz `.env` sÄ… ignorowane przez system kontroli wersji.
- **Error Handling**: W produkcji (`kReleaseMode`) stack trace bÅ‚Ä™du inicjalizacji jest ukryty przed uÅ¼ytkownikiem.

---

## 12. Architecture Master Plan Compliance (Directive 14)

WdroÅ¼ono rygorystyczne standardy architektoniczne zapewniajÄ…ce skalowalnoÅ›Ä‡ i Å‚atwoÅ›Ä‡ utrzymania 33+ ekranÃ³w.

### Feature-First Isolation

- KaÅ¼dy moduÅ‚ (M01-M08) posiada wÅ‚asny folder `repositories/` i `providers/`.
- **Zakaz wspÃ³Å‚dzielenia repozytoriÃ³w logÃ³w:** M03 korzysta z `GmpRepository`, M04 z `GhpRepository`. Zapobiega to "God Object" w warstwie danych.

### Wzorzec Repository -> Provider -> Screen

1. **Repository**: Czysty dostÄ™p do Supabase (np. `gmp_repository.dart`).
2. **Provider**: `AsyncNotifier` (np. `gmp_provider.dart`), ktÃ³ry zarzÄ…dza stanem Å‚adowania i bÅ‚Ä™dÃ³w.
3. **Screen**: Reaguje na stan providera (`ref.watch`) i wyÅ›wietla `SuccessOverlay` po udanym zapisie.

### Glove-Friendly Safety (Long Press)

- **HaccpLongPressButton**: Zgodnie z Master Planem, kaÅ¼dy przycisk typu "ZAPISZ" lub "ZATWIERDÅ¹" w moduÅ‚ach operacyjnych (M03, M04, M05) musi byÄ‡ przyciskiem typu Long Press. Eliminuje to bÅ‚Ä™dy wynikajÄ…ce z przypadkowych dotkniÄ™Ä‡ ekranu mokrÄ… rÄ™kÄ… lub w rÄ™kawicy.

### Unified Connectivity Logic

- **isOnlineProvider**: Centralny provider zwracajÄ…cy `bool`.
- **OfflineBanner**: Widget w `core/widgets/` reagujÄ…cy na brak sieci w czasie rzeczywistym.

---

## 13. Baza Danych (Supabase)

System opiera siÄ™ na relacyjnej bazie PostgreSQL hostowanej w Supabase. DostÄ™p do danych odbywa siÄ™ wyÅ‚Ä…cznie przez warstwÄ™ repoyztoriÃ³w (`repositories/`), ktÃ³re komunikujÄ… siÄ™ z API Supabase.

### 13.1 Schemat Tabel

PoniÅ¼ej przedstawiono strukturÄ™ gÅ‚Ã³wnych tabel wykorzystywanych w poszczegÃ³lnych moduÅ‚ach.

| Tabela | ModuÅ‚(y) | Opis | Kluczowe Kolumny |
|:---|:---|:---|:---|
| **`employees`** | M01, M07 | Pracownicy i uprawnienia | `id`, `full_name`, `pin_hash`, `role` (owner/manager/cook), `is_active`, `sanepid_expiry` |
| **`zones`** | M01 | Strefy w lokalu (np. Kuchnia) | `id`, `name`, `venue_id` |
| **`employee_zones`** | M01 | Przypisanie pracownika do strefy | `employee_id`, `zone_id` |
| **`sensors`** | M02 | Fizyczne czujniki IoT | `id`, `name`, `zone_id`, `is_active` |
| **`measurements`** | M02 | Logi temperatur (Realtime) | `id`, `sensor_id`, `temperature_celsius`, `timestamp` |
| **`haccp_logs`** | M03, M04 | Zunifikowane logi GMP i GHP | `id`, `category` (gmp/ghp), `form_id`, `data` (JSONB), `user_id`, `zone_id`, `created_at` |
| **`waste_records`** | M05, M06 | Rejestr odpadÃ³w | `id`, `venue_id`, `waste_type`, `mass_kg`, `photo_url`, `created_at` |
| **`generated_reports`** | M06 | Archiwum wygenerowanych PDF | `id`, `venue_id`, `report_type`, `generation_date`, `storage_path`, `created_by` |
| **`venues`** | M08 | Ustawienia lokalu | `id`, `name`, `address`, `nip`, `logo_url` |
| **`public_employees`** | M07 | Widok bezpieczny (bez hashy PIN) | (View) `id`, `full_name`, `role`, `is_active` |

### 13.2 PrzepÅ‚yw Danych (Data Flow)

KaÅ¼dy moduÅ‚ implementuje specyficzne zapytania do bazy. PoniÅ¼ej zestawienie operacji.

#### **M01: Autoryzacja (`AuthRepository`)**

- **Zapytanie (Secure RPC):** `login_with_pin(pin_input)` (Funkcja PostgreSQL `SECURITY DEFINER`).
- **Cel:** OminiÄ™cie blokady RLS dla uÅ¼ytkownika anonimowego przy weryfikacji hasha PIN.
- **Zwrot:** Obiekt `Employee` (token sesji w aplikacji, brak JWT od Supabase w trybie Kiosk).
- **Strefy:** `SELECT` z `employee_zones` join `zones`.

#### **M02: Monitoring (`MeasurementsRepository`)**

- **Zapytanie:** `STREAM` (Subscribe) na tabelÄ™ `temperature_logs` (lub `measurements`).
- **Zwrot:** StrumieÅ„ listy `TemperatureLog` (ostatnie 20 wpisÃ³w sortowane po czasie).
- **Czujniki:** `SELECT` z `sensors` dla danej strefy.

#### **M03 (GMP) & M04 (GHP) (`GmpRepository` / `GhpRepository`)**

- **Zapis:** `INSERT` do tabeli `haccp_logs`.
  - RozrÃ³Å¼nienie rekordÃ³w poprzez kolumnÄ™ `category`: `'gmp'` lub `'ghp'`.
  - Dane formularza (temperatury, odpowiedzi tak/nie) lÄ…dujÄ… w kolumnie `data` jako JSONB.
- **Odczyt (Historia):** `SELECT` z `haccp_logs` filtrowane po `category` i `zone_id`.
- **Zwrot:** Lista map JSON.

#### **M05: Odpady (`WasteRepository`)**

- **Zapis:**
    1. Upload zdjÄ™cia do Storage (`waste-docs`).
    2. `INSERT` do `waste_records` z otrzymanym `photo_url`.
- **Odczyt:** `SELECT` z `waste_records` dla danego `venue_id`.

#### **M06: Raporty (`ReportsRepository`)**

- **Odczyt:** Agregacja danych z `waste_records`, `measurements` oraz logÃ³w.
- **Persistence:** Automatyczny zapis wygenerowanych PDF w tabeli `generated_reports` oraz bucket `reports` w Supabase Storage.
- **Data Range:** Raporty CCP-3 sÄ… generowane dla konkretnego dnia na podstawie pola `generation_date`.
- **UWAGA:** Raporty korzystajÄ… teraz z ujednoliconej tabeli `haccp_logs`.

#### **M07: HR (`HrRepository`)**

- **Odczyt:** `SELECT` z widoku `public_employees` (bezpieczne listowanie).
- **Zapis:** `INSERT`/`UPDATE` na tabeli `employees` (wymaga RLS role='manager'/'owner' - w trybie kiosk symulowane przez logikÄ™ aplikacji guarding routes).

#### **M08: Ustawienia (`VenueRepository`)**

- **Zapis:** `UPDATE` na tabeli `venues`.
- **Logo:** Upload do bucketu `branding`, zapis URL w `venues.logo_url`.

### 13.3 BezpieczeÅ„stwo (RLS & Policies)

Mimo trybu Kiosk (gdzie czÄ™sto uÅ¼ywa siÄ™ jednego Service Role lub anonimowego dostÄ™pu), wdroÅ¼ono RLS:

1. **Employees:** DostÄ™p do `pin_hash` jest zablokowany dla zwykÅ‚ych zapytaÅ„ `SELECT *`. DostÄ™p tylko przez RPC `login_with_pin`.
2. **Audit:** Trigger `handle_updated_at` automatycznie uzupeÅ‚nia czasy edycji.
3. **Storage:** Buckety `waste-docs` i `branding` majÄ… polityki `SELECT` public (lub authenticated) oraz `INSERT` tylko dla uwierzytelnionych sesji (Anonimowych).

---

## 14. Log Zmian w Bazie Danych (Naprawy Krytyczne)

W dniu 2026-02-14 przeprowadzono seriÄ™ napraw struktury bazy danych w celu przywrÃ³cenia funkcjonalnoÅ›ci logowania i stref.

1. **RPC Login (`12_auth_rpc.sql`)**: WdroÅ¼ono funkcjÄ™ `login_with_pin` w celu bezpiecznej weryfikacji PIN bez naruszania RLS.
2. **Anonymous Auth (`13_fix_haccp_logs.sql`)**:
    - Aplikacja wykonuje teraz `signInAnonymously()`.
    - Utworzono brakujÄ…cÄ… tabelÄ™ `haccp_logs` (zamiast rozdzielnych `gmp`/`ghp`) i zabezpieczono jÄ… RLS.
3. **Data Integrity (`14_data_fix_hashes.sql`)**:
    - Zaktualizowano PINy w tabeli `employees` z wersji plain text (`1234`) na hashe SHA-256.
4. **Venues & Zones Fix (`15/16_fix_venues_and_zones.sql`)**:
    - Utworzono brakujÄ…cÄ… tabelÄ™ `venues`.
    - Dodano kolumnÄ™ `venue_id` do tabeli `zones`.
    - PrzywrÃ³cono spÃ³jnoÅ›Ä‡ danych poprzez przypisanie wszystkich stref do domyÅ›lnego lokalu.

5. **Report Persistence (`31_create_generated_reports.sql`)**:
    - WdroÅ¼ono tabelÄ™ `generated_reports` do archiwizacji PDF.
    - Skonfigurowano bucket `reports` z politykami dostÄ™pu dla Kiosk/Anon mode.
    - Dodano pole `comments` do formularza chÅ‚odzenia (CCP-3) dla dziaÅ‚aÅ„ korygujÄ…cych.

## 15. RozwiÄ…zywanie ProblemÃ³w (Troubleshooting)

### 15.1 Vercel Build Errors (Common Issues)

W dniu 2026-02-15 zidentyfikowano i naprawiono szereg bÅ‚Ä™dÃ³w blokujÄ…cych wdroÅ¼enie na Vercel. PoniÅ¼sza lista sÅ‚uÅ¼y jako referencja przy przyszÅ‚ych problemach:

1. **BÅ‚Ä™dy Kompilacji (Compilation Errors):**
    - **BÅ‚Ä…d:** `Duplicated parameter name 'address'`.
    - **PowÃ³d:** Dwukrotne zdefiniowanie tego samego parametru w sygnaturze metody (np. w `VenueRepository`).
    - **RozwiÄ…zanie:** UsuniÄ™cie powtarzajÄ…cego siÄ™ parametru.

2. **BrakujÄ…ce Importy (Missing Imports):**
    - **BÅ‚Ä…d:** `Couldn't find constructor 'GhpHistoryScreen'`.
    - **PowÃ³d:** Zapomniany import ekranu w pliku `app_router.dart`.
    - **RozwiÄ…zanie:** Regularne sprawdzanie komunikatÃ³w builda, ktÃ³re wskazujÄ… konkretne pliki i linie.

3. **BÅ‚Ä™dy TypÃ³w w Badge'ach (Dashboard Badges):**
    - **BÅ‚Ä…d:** `The getter 'count' isn't defined for the type 'int'`.
    - **PowÃ³d:** Metoda `.count()` w nowszych wersjach Supabase SDK zwraca bezpoÅ›rednio `int` zamiast obiektu z polem `.count`.
    - **RozwiÄ…zanie:** BezpoÅ›rednie uÅ¼ycie wyniku (np. `if (count > 0)`).

4. **BÅ‚Ä™dne Referencje Design Tokens:**
    - **BÅ‚Ä…d:** `Member not found: 'radiusMedium'`.
    - **PowÃ³d:** OdwoÅ‚anie do nieistniejÄ…cego tokenu w `HaccpDesignTokens`.
    - **RozwiÄ…zanie:** Sprawdzenie dostÄ™pnych tokenÃ³w w `lib/core/constants/design_tokens.dart` i uÅ¼ycie np. `cardRadius`.

5. **PrzestarzaÅ‚a SkÅ‚adnia i KolejnoÅ›Ä‡ Filtrowania Supabase:**
    - **BÅ‚Ä…d:** `The method 'filter' (lub 'in_') isn't defined for the type 'PostgrestTransformBuilder'`.
    - **PowÃ³d:** WywoÅ‚anie `.order()`, `.limit()` lub `.range()` zmienia typ buildera na `TransformBuilder`, ktÃ³ry nie obsÅ‚uguje juÅ¼ metod filtrujÄ…cych. Wszystkie filtry (`.eq()`, `.filter()`, `.in_()`) muszÄ… wystÄ…piÄ‡ **PRZED** metodami sortowania/limitowania.
    - **RozwiÄ…zanie:** ZastÄ…pienie `.in_('col', list)` przez `.filter('col', 'in', list)` oraz przesuniÄ™cie `.order()` na sam koniec Å‚aÅ„cucha zapytaÅ„.

### 15.2 Problem "Stale Cache" na Vercelu

JeÅ›li build na Vercel **nie powiedzie siÄ™ (Failed)**, platforma moÅ¼e serwowaÄ‡ **poprzedniÄ… dziaÅ‚ajÄ…cÄ… wersjÄ™** aplikacji (cached build).

- **Objaw:** WprowadziÅ‚eÅ› poprawkÄ™ (np. usunÄ…Å‚eÅ› hardcoded ID), ale w przeglÄ…darce nadal widzisz stary bÅ‚Ä…d.
- **DziaÅ‚anie:** Zawsze sprawdzaj status deploymentu w panelu Vercel. JeÅ›li jest czerwony ("Error"), popraw bÅ‚Ä™dy kompilacji pokazane w logach, zpushuj kod i poczekaj na status "Ready".

## 6. M02 - Monitoring & IoT (Directive 14)

ModuÅ‚ ten odpowiada za strumieniowe odbieranie danych z czujnikÃ³w temperatury, generowanie alarmÃ³w i wizualizacjÄ™ danych. Jest to jeden z najbardziej krytycznych elementÃ³w systemu pod kÄ…tem wydajnoÅ›ci i UX.

### 6.1 Architektura Danych

Z powodu ograniczeÅ„ Supabase Realtime (brak moÅ¼liwoÅ›ci filtrowania po JOIN-ach `measurements` -> `devices` -> `zones`), przyjÄ™to architekturÄ™ **dwuetapowÄ… (`Two-Stage Streaming`)**:

1. **Global Stream:** Subskrybujemy tabelÄ™ `measurements` (INSERT) bez filtrowania po strefie, ale z filtrem `venue_id`.
2. **Local Filtering:** W aplikacji (`MonitoringProvider`) sprawdzamy kaÅ¼de przychodzÄ…ce zdarzenie payloadu. JeÅ›li `device_id` pomiaru naleÅ¼y do aktualnie wybranej strefy (mapa `device -> zone` w pamiÄ™ci), pomiar jest procesowany. W przeciwnym razie jest ignorowany.

Plik odpowiedzialny: `lib/features/m02_monitoring/repositories/measurements_repository.dart`

### 6.2 Kluczowe Komponenty

1. **Repository Layer (`MeasurementsRepository`)**:
    - ObsÅ‚uguje strumieÅ„ realtime.
    - Pobiera historiÄ™ pomiarÃ³w (ostatnie 24h) przy starcie.
    - ObsÅ‚uguje funkcjÄ™ `acknowledgeAlert` (aktualizacja pola `is_acknowledged` w `temperature_logs`).

2. **State Management (`MonitoringProvider`)**:
    - UdostÄ™pnia `activeSensorsProvider` (lista sensorÃ³w w strefie).
    - UdostÄ™pnia `latestMeasurementsProvider` (mapa `sensor_id -> Measurement`).
    - Oblicza statusy alarmowe w czasie rzeczywistym.

3. **UI Components**:
    - `TemperatureDashboardScreen`: GÅ‚Ã³wny widok z kafelkami sensorÃ³w.
    - `SensorChartScreen`: Wykres temperatury (biblioteka `fl_chart`) z przedziaÅ‚ami czasowymi (1h, 6h, 12h, 24h).
    - `AlarmsPanelScreen`: Lista aktywnych i historycznych alarmÃ³w z funkcjÄ… potwierdzania (Long Press).

### 6.3 Decyzje Projektowe

- **Glove-Friendly UX:** Wszystkie interakcje krytyczne (potwierdzenie alarmu) wymagajÄ… przytrzymania przycisku przez 1 sekundÄ™ (`HaccpLongPressButton`) co zapobiega przypadkowym klikniÄ™ciom w rÄ™kawicach.
- **Dark Mode Only:** Interfejs jest zoptymalizowany pod kÄ…tem pracy w ciemnych pomieszczeniach (chÅ‚odnie), uÅ¼ywajÄ…c ciemnego tÅ‚a i jaskrawych kolorÃ³w akcentowych (zielony/czerwony) dla szybkiej identyfikacji statusu.

### 15.3 Troubleshooting M02 (Missing Sensors)

W przypadku bÅ‚Ä™du "Brak aktywnych sensorÃ³w w tej strefie", mimo Å¼e dane sÄ… w bazie:

1. **Problem: RLS Role Mismatch**
   - **Przyczyna:** Aplikacja uÅ¼ywa `signInAnonymously()`. JeÅ›li anonimowe logowanie jest wyÅ‚Ä…czone w Supabase, klient uÅ¼ywa roli `anon`. JeÅ›li polityka RLS zezwala tylko `authenticated`, dane sÄ… blokowane.
   - **RozwiÄ…zanie:** Skrypt `27_fix_rls_anon.sql` nadaje uprawnienia obu rolom (`anon`, `authenticated`).

2. **Problem: Zone ID Mismatch**
   - **Przyczyna:** Sensory sÄ… przypisane do strefy o nazwie "Kuchnia", ale z innym ID niÅ¼ ta, do ktÃ³rej ma dostÄ™p aktualny pracownik.
   - **RozwiÄ…zanie:** Skrypty diagnostyczne `23_diagnostic_mismatch.sql` oraz naprawczy `25_fix_force_kuchnia.sql`, ktÃ³ry precyzyjnie paruje sensory z ID strefy zalogowanego uÅ¼ytkownika.

---

## 16. Pipeline ChÅ‚odzenia â†’ Baza Danych â†’ Raporty (Plan Implementacji)

Sekcja opisuje peÅ‚ny przepÅ‚yw danych od formularza M03 przez bazÄ™ po generowanie raportu CCP-3 w M06.

### 16.1 Architektura PrzepÅ‚ywu (Data Flow)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  FoodCoolingForm     â”‚     â”‚    Supabase DB        â”‚     â”‚   Raport CCP-3       â”‚
â”‚  (M03)               â”‚     â”‚                      â”‚     â”‚   (M06)              â”‚
â”‚                     â”‚     â”‚                      â”‚     â”‚                      â”‚
â”‚ DynamicFormRenderer  â”‚     â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚     â”‚  ReportsRepository   â”‚
â”‚ â†“                   â”‚â”€â”€â”€â”€â–¶â”‚  â”‚  haccp_logs     â”‚  â”‚â”€â”€â”€â”€â–¶â”‚  .getCoolingLogs()   â”‚
â”‚ GmpProvider          â”‚     â”‚  â”‚  category='gmp' â”‚  â”‚     â”‚  â†“                  â”‚
â”‚ â†“                   â”‚     â”‚  â”‚  form_id=       â”‚  â”‚     â”‚  PdfService          â”‚
â”‚ GmpRepository        â”‚     â”‚  â”‚    'food_coolingâ”‚  â”‚     â”‚  .generateCcp3Report â”‚
â”‚ .insertLog()         â”‚     â”‚  â”‚    _daily'      â”‚  â”‚     â”‚  â†“                  â”‚
â”‚                     â”‚     â”‚  â”‚  data=JSONB     â”‚  â”‚     â”‚  Ccp3PreviewScreen   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚                      â”‚
                            â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
                            â”‚  â”‚  products       â”‚  â”‚
                            â”‚  â”‚  name, type     â”‚  â”‚
                            â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
                            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 16.2 Znane Bugi (Do Naprawy Przed Sprintem 1)

| # | Bug | Plik | Opis |
|---|-----|------|------|
| 1 | **form_id mismatch** | `food_cooling_form_screen.dart` L20 vs `reports_repository.dart` L27 | Formularz zapisuje `form_id='food_cooling_daily'`, ale `ReportsRepository.getCoolingLogs()` filtruje po `form_id='food_cooling'`. **Dane nigdy nie sÄ… znajdowane w raporcie.** |
| 2 | **Brak widgetu Text** | `dynamic_form_renderer.dart` | `HaccpFieldType.text` (pole "Uwagi") wpada do `default:` i renderuje placeholder zamiast funkcjonalnego pola tekstowego. |
| 3 | **Duplikat @riverpod** | `gmp_provider.dart` L43-44 | PodwÃ³jna adnotacja `@riverpod` nad `gmpHistory`. |
| 4 | **Brak trasy CCP-3** | `app_router.dart` | Trasa `/reports/preview/ccp3` prawdopodobnie nie jest zarejestrowana w GoRouter, co powoduje bÅ‚Ä…d nawigacji po zapisaniu formularza. |

### 16.3 Struktura JSONB w `haccp_logs.data`

Po zapisaniu formularza ChÅ‚odzenia, kolumna `data` (JSONB) zawiera:

```json
{
  "product_name": "Pierogi Ruskie",
  "prep_date": "2026-02-19",
  "start_temp": 65,
  "start_time": "14:00",
  "temp_2h": 20,
  "end_temp": 4,
  "end_time": "16:15",
  "comments": "Brak uwag"
}
```

ModuÅ‚ raportÃ³w (`PdfService._generateCcp3PdfIsolate`) odczytuje te pola z mapy `data` i mapuje je na kolumny tabeli PDF.

---

### 16.4 Plan SprintÃ³w (Dla Junior Developera)

#### Sprint 1: Naprawa Krytycznych BugÃ³w (Bug Fixes)

**Cel:** Formularz zapisuje dane poprawnie â†’ raport znajduje te dane â†’ nawigacja dziaÅ‚a.

**Zadania:**

1. **Ujednolicenie `form_id`**
   - W pliku `food_cooling_form_screen.dart` zmieÅ„ `const String formId = 'food_cooling_daily'` na `'food_cooling'`.
   - **LUB** w pliku `reports_repository.dart` zmieÅ„ `.eq('form_id', 'food_cooling')` na `.eq('form_id', 'food_cooling_daily')`.
   - Wybierz **jednÄ…** wersjÄ™ i uÅ¼yj jej wszÄ™dzie. Zalecane: `'food_cooling'` (krÃ³tsze, spÃ³jne z konwencjÄ…).

2. **UsuniÄ™cie duplikatu `@riverpod`**
   - W pliku `gmp_provider.dart` linia 43-44: usuÅ„ jednÄ… z dwÃ³ch adnotacji `@riverpod`.
   - Uruchom `dart run build_runner build --delete-conflicting-outputs` po edycji.

3. **Dodanie trasy CCP-3 do GoRouter**
   - W pliku `app_router.dart` dodaj trasÄ™:

     ```
     /reports/preview/ccp3?date=...
     ```

   - Parametr `date` (queryParam) parsuj na `DateTime` i przekaÅ¼ do `Ccp3PreviewScreen(date: ...)`.

4. **Weryfikacja:**
   - WypeÅ‚nij formularz â†’ Zapisz â†’ SprawdÅº w Supabase Dashboard, Å¼e wiersz pojawiÅ‚ siÄ™ w `haccp_logs` z poprawnym `form_id`.
   - SprawdÅº, Å¼e nawigacja do podglÄ…du CCP-3 dziaÅ‚a (nie pokazuje biaÅ‚ego/pustego ekranu lub 404).

---

#### Sprint 2: Implementacja BrakujÄ…cego Widgetu Text

**Cel:** Pole "Uwagi / DziaÅ‚ania korygujÄ…ce" w formularzu jest w peÅ‚ni funkcjonalne.

**Zadania:**

1. **StwÃ³rz widget `HaccpTextInput`**
   - Plik: `lib/features/shared/widgets/dynamic_form/haccp_text_input.dart`.
   - Widget typu `StatelessWidget` wyÅ›wietlajÄ…cy `TextField` z ciemnym tÅ‚em (`HaccpDesignTokens.surface`).
   - Parametry: `String? value`, `ValueChanged<String> onChanged`, `String? hintText`.
   - **Glove-Friendly:** Min. height 56dp, duÅ¼y fontSize (16), jasny placeholder.

2. **Dodaj case do `DynamicFormRenderer`**
   - W `_buildField()`, przed `default:`, dodaj:

     ```
     case HaccpFieldType.text:
       return HaccpTextInput(...)
     ```

   - Import nowego pliku.

3. **Weryfikacja:**
   - OtwÃ³rz formularz ChÅ‚odzenia â†’ Pole "Uwagi" powinno byÄ‡ edytowalne (klawiatura pojawia siÄ™ przy klikniÄ™ciu).
   - Zapisz formularz z wypeÅ‚nionym polem "Uwagi" â†’ SprawdÅº w Supabase, Å¼e `data.comments` ma wartoÅ›Ä‡.

---

#### Sprint 3: Integracja Raportu z Danymi z Bazy

**Cel:** Po zapisaniu formularza uÅ¼ytkownik automatycznie widzi wygenerowany raport PDF z danymi.

**Zadania:**

1. **Poprawka `_handleSubmit` w `food_cooling_form_screen.dart`**
   - UsuÅ„ blok komentarzy TODO (linie ~70-127).
   - Po `HaccpSuccessOverlay.show(context)`:
     - Parsuj `dateStr` z `state.values['prep_date']`.
     - Nawiguj: `context.push('/reports/preview/ccp3?date=$dateStr')`.

2. **SprawdÅº `Ccp3PreviewScreen`**
   - `ccp3ReportProvider` pobiera logi za dany dzieÅ„ via `repo.getCoolingLogs(date)`.
   - Upewnij siÄ™, Å¼e `getCoolingLogs` filtruje po `form_id` **spÃ³jnym** z wartoÅ›ciÄ… ustalonÄ… w Sprincie 1.
   - Zweryfikuj, Å¼e `PdfService.generateCcp3Report` poprawnie mapuje pola JSONB (patrz sekcja 16.3).

3. **ObsÅ‚uga pustych danych**
   - JeÅ›li `logs` jest puste (np. brak danych za dany dzieÅ„), wyÅ›wietl komunikat zamiast pustego PDF.
   - W `Ccp3PreviewScreen`: sprawdÅº `logs.isEmpty` i pokaÅ¼ `HaccpEmptyState`.

4. **Weryfikacja:**
   - WypeÅ‚nij formularz â†’ ZAPISZ â†’ powinien pojawiÄ‡ siÄ™ podglÄ…d PDF z danymi z formularza.
   - SprawdÅº, Å¼e tabela w PDF zawiera poprawne wartoÅ›ci (produkt, temperatury, godziny).

---

#### Sprint 4: TrwaÅ‚oÅ›Ä‡ RaportÃ³w (Persistence)

**Cel:** Wygenerowane raporty sÄ… archiwizowane w chmurze i dostÄ™pne do przeglÄ…dania / pobrania.

**Zadania:**

1. **Uruchom SQL migracjÄ™ `31_create_generated_reports.sql`** (jeÅ›li jeszcze nie uruchomiona)
   - Tabela `generated_reports`: `id`, `venue_id`, `report_type`, `generation_date`, `storage_path`, `created_by`, `created_at`.
   - Bucket `reports` w Supabase Storage.

2. **Dodaj przycisk "Zapisz do chmury" w `Ccp3PreviewScreen`**
   - Po wygenerowaniu PDF (`pdfAsync.data`):
     - Upload `Uint8List` do Supabase Storage: `reports/ccp3/YYYY-MM-DD_HHmmss.pdf`.
     - Insert do `generated_reports` z metadanymi.
   - PokaÅ¼ `SnackBar` sukcesu.

3. **Lista zapisanych raportÃ³w w module M06**
   - W istniejÄ…cym `ReportsPanelScreen` dodaj sekcjÄ™ "Archiwum CCP-3".
   - Pobierz z `generated_reports` WHERE `report_type = 'ccp3'`.
   - WyÅ›wietl listÄ™ z datÄ… i przyciskiem "OtwÃ³rz" (pobiera z Storage i otwiera w viewerze).

4. **Weryfikacja:**
   - Zapisz PDF â†’ sprawdÅº w Supabase Storage, Å¼e plik istnieje.
   - OtwÃ³rz Archiwum â†’ kliknij na raport â†’ powinien siÄ™ otworzyÄ‡ ten sam PDF.

---

#### Sprint 5: Produkty z Bazy Danych (Products Table)

**Cel:** Dropdown produktÃ³w w formularzu Å‚aduje opcje z bazy danych zamiast hardcodowanych list.

**Zadania:**

1. **Uruchom SQL migracjÄ™ `33_create_products_table.sql`** w Supabase Dashboard
   - Tworzy tabelÄ™ `products` z kolumnami `id`, `name`, `type`, `created_at`.
   - Dodaje seed data (Pierogi, GoÅ‚Ä…bki, Bigos).

2. **SprawdÅº dziaÅ‚anie `HaccpDropdown`**
   - Widget jest juÅ¼ zaimplementowany (`haccp_dropdown.dart`).
   - Konfiguracja formularza (`form_definitions.dart`) wskazuje na `source: 'products_table'`, `type: 'cooling'`.
   - `ProductsRepository` (`products_repository.dart`) pobiera dane z tabeli.
   - **TEST:** OtwÃ³rz formularz â†’ dropdown powinien zaÅ‚adowaÄ‡ produkty z Supabase (nie z hardcodowanej listy).

3. **Dodaj ekran "ZarzÄ…dzanie Produktami" (opcjonalnie)**
   - Prosty CRUD screen dostÄ™pny z UstawieÅ„ (M08) dla roli `manager`/`owner`.
   - Lista produktÃ³w z przyciskiem "Dodaj nowy".

4. **Weryfikacja:**
   - Dodaj nowy produkt w Supabase (np. "Pierogi z Serem") â†’ otwÃ³rz formularz â†’ nowy produkt powinien pojawiÄ‡ siÄ™ w dropdown.

---

### 16.5 KolejnoÅ›Ä‡ PriorytetÃ³w

| # | Sprint | Priorytet | Uzasadnienie |
|---|--------|-----------|-------------|
| 1 | Bug Fixes | ğŸ”´ KRYTYCZNY | Bez tego dane nie docierajÄ… do raportu |
| 2 | Widget Text | ğŸŸ  WYSOKI | Pole "Uwagi" jest wymagane w procesie HACCP |
| 3 | Integracja Raportu | ğŸŸ  WYSOKI | Core feature: automatyczny raport po zapisie |
| 4 | Persistence | ğŸŸ¡ ÅšREDNI | Archiwizacja dla audytu |
| 5 | Produkty DB | ğŸŸ¢ NISKI | JuÅ¼ czÄ™Å›ciowo dziaÅ‚a (migracja do uruchomienia) |

---
Autor: Antigravity (AI Agent)
Data wersji: 2026-02-19 (M03â†’M06 Pipeline Plan & Form Improvements)
